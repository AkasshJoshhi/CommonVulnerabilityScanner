const express = require('express');
const app = express();
var socketApp = express();
var http = require('http').createServer(socketApp);
var io = require('socket.io')(http);

var {appPort,socketAppPort}=require('./config/config');

var socketObject = 0;
var parser = require('body-parser');
var path = require('path');
app.use(parser.urlencoded({ extended: false }));
app.use(parser.json());
app.set('view engine','ejs');
app.set('views',path.join(__dirname,'app_views'));

io.on('connection', (socket)=>{
    socket.emit('log_message','connected! Initiating hunting socket...');
    socketObject = socket;
  });

app.use('/check',express.static(path.join(__dirname, 'public')));
app.use('/',express.static(path.join(__dirname, 'public')));

var rootRouter = require('./router/rootPath');
var checkRouter = require('./router/checkPath');
//var socketRouter =  require('./router/socketPath');

app.use('/',rootRouter);
app.use('/check',(req,res,next)=>{
    req.socketObject = socketObject;
    next();
},checkRouter);
//app.use('/socket',socketRouter);
//=====================================SOCKET CODE START==========================================//
app.get('/socket/getJSONdata',(req,res)=>{
    var jsonDbFilePath = require('./config/config').database.dbFilePath;  
    res.sendFile(path.resolve(jsonDbFilePath));

});
//=====================================SOCKET CODE END===========================================//

http.listen(socketAppPort, function(){
  console.log(`[+] listening on ${socketAppPort} : log monitor server`);
});
appPort=process.env.PORT||appPort;
app.listen(appPort,()=>{
    console.log(`App running on PORT ${appPort}`);
});