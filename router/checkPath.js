var express = require('express');
var Router = express.Router();

var checkerFunc = require('../checkers/checkInDB.js');
var jsonDbFilePath = require('../config/config').database.dbFilePath; 

var {corsFunc, 
    hhiFunc,
    dmhttpFunc,
    subtakeFunc,
    ctpFunc,
    cfcFunc,
    orcFunc,
    sslTestFunc,
    psesFunc,
deleteTarget,
masterCFunc} = require('../controllers/mainGET.js');

var {POST_corsFunc,
    POST_hhiFunc,
    POST_dmhttpFunc,
    POST_subtakeFunc,
    POST_ctpFunc,
    POST_cfcFunc,
    POST_orcFunc,
    POST_sslTestFunc,
    POST_psesFunc,
    POST_masterCFunc} = require('../controllers/mainPOST.js');

var fs = require("fs");

Router.use(async (req,res,next)=>{
    if(typeof(req.query.deleteTargetName)=="undefined"){
    if(req.method == "POST" ||  req.method == "GET"){
        var domainName;
        
        if(req.method=="POST"){domainName=req.body.domainName}
        else{domainName=req.query.domainName}

        let ifinDB = await checkerFunc(domainName) || false;

        if(!ifinDB){
            var addDomain2FileDB = require('../controllers/addDomain2FileDB.js');
            var addSD2FileDB = require('../controllers/addSD2FileDB.js');


            var dbData = JSON.parse(fs.readFileSync(jsonDbFilePath,'utf-8'));
                console.log(`[+] Domain not found in DB\n[+] Adding Domain to DB\n`);
                await addDomain2FileDB(dbData,domainName);

            var dbData1 = JSON.parse(fs.readFileSync(jsonDbFilePath,'utf-8'));
                console.log(`[+] Enumerating Subdomains\n`);
                await addSD2FileDB(dbData1,domainName);
            
        }
        else{
            console.log(`[+]Domain Found In DB --> ${domainName}`);
        }
        
    }
}
    //console.log(req.socketObject)
    next();
});


Router.route('/getInfo')
.get((req,res)=>{
    res.redirect("/recon_tab")
});

Router.route('/cors')
.get(corsFunc)
.post(POST_corsFunc);

Router.route('/hhi')
.get(hhiFunc)
.post(POST_hhiFunc);

Router.route('/dmhttp')
.get(dmhttpFunc)
.post(POST_dmhttpFunc);

Router.route('/subtake')
.get(subtakeFunc)
.post(POST_subtakeFunc);

Router.route('/ctp')
.get(ctpFunc)
.post(POST_ctpFunc);

Router.route('/cfc')
.get(cfcFunc)
.post(POST_cfcFunc);

Router.route('/orc')
.get(orcFunc)
.post(POST_orcFunc);

Router.route('/sslt')
.get(sslTestFunc)
.post(POST_sslTestFunc);

Router.route('/pses')
.get(psesFunc)
.post(POST_psesFunc);

Router.route('/masterCheck')
.get(masterCFunc)
.post(POST_masterCFunc);

Router.route('/deleteTarget')
.get(async (req,res)=>{
    var domainName = req.query.deleteTargetName;
    await deleteTarget(domainName,res)
});

module.exports = Router;