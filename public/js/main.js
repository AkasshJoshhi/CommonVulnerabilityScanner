var xhttp = new XMLHttpRequest();

function cp_toggle(){
    $('a[name="close-cp-sym"]').click(function(){
        $('#cpanel').css('display','none');
        $('a[name="open-cp-sym"]').attr('style','display:block');
      });
      $('a[name="open-cp-sym"]').click(function(){
        $('#cpanel').css('display','block');
        $('a[name="open-cp-sym"]').attr('style','display:none');
      });

    $("input[name='toggle']").click(()=>{
    
    if($('#scan-collapse').css('display')=='none'){
      $('#scan-collapse').attr('style','display: block');
  
      $('#myCoolSwitch').addClass('switch-box-shadow');
      $('#id-switch').addClass('switch-box-shadow');
  
      $('#myCoolSwitch').removeClass('just-green-box-glow');
      $('#id-switch').removeClass('just-green-box-glow');
  
      $('#cp-text').removeClass('glow');
      $('#cp-text').addClass('non-active-tab');
  
      $('#cp-mode').removeClass('just-green-glow');
      $('#cp-mode').addClass('non-active-tab');
      $('#cp-mode').html('[inactive]');
  
      $('#scan-collapse').removeClass('non-active-tab');
      $('#scan-collapse').addClass('glow');
  
      $('#sc-mode').removeClass('non-active-tab');
      $('#sc-mode').addClass('just-green-glow');
  
      $('body').css("filter","blur(0px)");
  
      $('.cpnsc').removeClass('no-grey-shadow-but-white');
      $('.cpnsc').addClass('grey-box-shadow');
      $('#cp-tab').attr('style','display: none');

      $("a[name='close-cp-sym']").show();
    }
    else{
      $('#scan-collapse').attr('style','display: none');
  
      $('#myCoolSwitch').addClass('just-green-box-glow');
      $('#id-switch').addClass('just-green-box-glow');
  
      $('#myCoolSwitch').removeClass('switch-box-shadow');
      $('#id-switch').removeClass('switch-box-shadow');
      
      $('#cp-text').addClass('glow');
      $('#cp-text').removeClass('non-active-tab');
  
      $('#cp-mode').addClass('just-green-glow');
      $('#cp-mode').removeClass('non-active-tab');
      $('#cp-mode').html('[ active ]');
  
      $('#scan-collapse').addClass('non-active-tab');
      $('#scan-collapse').removeClass('glow');
  
      $('#sc-mode').addClass('non-active-tab');
      $('#sc-mode').removeClass('just-green-glow');
      
      $('.cpnsc').removeClass('grey-box-shadow');
      $('.cpnsc').addClass('no-grey-shadow-but-white')
  
      $('#cp-tab').attr('style','display: block');
      $("a[name='close-cp-sym']").hide();
    }
  });
  $('.rolldown-list li').each(function () {
    var delay = ($(this).index() / 9) + 's';
    $(this).css({
      webkitAnimationDelay: delay,
      mozAnimationDelay: delay,
      animationDelay: delay
    });
  });

  $('div[name="master-check"]').click(()=>{
        xhttp.open("GET",'masterCheck',true);
        xhttp.send();
        $('<div style="color:yellow" class="lds-facebook"><div></div><div></div><div></div></div><div style="color:yellow">Loading...</div>').prependTo(document.getElementById('gear0'));
        xhttp.onreadystatechange = function(){
            if(this.status==200&&this.readyState==4){
                console.log("MasterCheck Initiated!");
                console.log(xhttp.responseText);
            }
        }

  });
  // $('form[class="scanner-option"]').submit(()=>{
  //   $('<div style="color:yellow" class="lds-facebook"><div></div><div></div><div></div></div><div style="color:yellow">Loading...</div>').prependTo(document.getElementById('gear0'));
    
  //   e.preventDefault();
  // });

  }
  function load1(){
    $('div[id="gear0"]').empty();
  };
function acton(idref,endpoint){
  $('<div style="color:yellow" class="lds-facebook"><div></div><div></div><div></div></div><div style="color:yellow">Loading...</div>').prependTo(document.getElementById('gear0'));
  var domainName = $(`input[id='${idref}']`).attr('value');
  xhttp.open("POST",`${endpoint}`,true);
  xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

     xhttp.onreadystatechange = function(){
           if(this.status==200 && this.readyState == 4){
             console.log(xhttp.responseText);
             $('#log_mon').append($(xhttp.responseText));
             load1();
             Swal.fire({
              position: 'center',
              icon: 'success',
              title: '<b style="color:yellow;font-size:30px;">'+`log monitor active`+"</b>&nbsp;",
              showConfirmButton: false,
              timer: 1500
            })
            
           }
     }
     xhttp.send(`domainName=${domainName}`); 
}

function checklist_refresh(string){
     xhttp.open("GET",string,true);
     xhttp.send();

     xhttp.onreadystatechange = function(){
           if(this.status==200 && this.readyState == 4){
             console.log(xhttp.responseText);
             createOptioninList(xhttp.responseText);
           }
     }

     function createOptioninList(res){
 
       var new_div = document.createElement('div');
       $('#form-chk').append(new_div);

       var new_option;
       var json_res = JSON.parse(res);
      
       for(var num in json_res.domainArray){
        var domainName = json_res.domainArray[num]
         var name = domainName.replace(".","");
         var subd_array = json_res["subd"]["enumSubd"][domainName];
         
          var subd_string = subd_array.join('\n');
         $(`<input height="70px" width="70px" type="checkbox" name="${domainName}" class="form-check-input" id="materialChecked-${name}" onchange="handleChange(this);">
         <label class="form-check-label" for="materialChecked-${name}"><a href="http://${domainName}">${domainName}</a></label>
         <div class="glyphicon glyphicon-arrow-right btn btn-info" style="color:green;float:right;" data-toggle="collapse" data-target="#info_res-${name}"></div>
         <a><div class="glyphicon glyphicon-refresh btn btn-info" style="color:green;float:right;"></div></a>
         <a id="${domainName}" onclick="deleteTarget(this);"><div class="glyphicon glyphicon-trash btn btn-danger" style="color:white;float:right;"></div></a>
         <div id="info_res-${name}" class="collapse">
           <ul class="nav nav-tabs md-tabs" id="myTabMD-${name}" role="tablist">
             <li class="nav-item">
               <a class="nav-link active btn btn-lg btn-danger" id="info-tab-md-${name}" data-toggle="tab" href="#info-md-${name}" role="tab" aria-controls="info-md-${name}"
                 aria-selected="true">Info Tab</a>
             </li>
             <li class="nav-item">
               <a class="nav-link btn btn-lg btn-info" id="checklist-tab-md-${name}" data-toggle="tab" href="#checklist-md-${name}" role="tab" aria-controls="checklist-md-${name}"
                 aria-selected="false">Checklist</a>
             </li>
           </ul>
           <div class="tab-content card pt-5" id="myTabContentMD-${name}">
             <div class="tab-pane fade" id="checklist-md-${name}" role="tabpanel" aria-labelledby="checklist-tab-md-${name}">
             <ul>
             
             </ul>
             </div>
             <div class="tab-pane fade" id="info-md-${name}" role="tabpanel" aria-labelledby="info-tab-md-${name}">
             <ul>
               <li><div class="glyphicon glyphicon-triangle-right btn btn-info" style="color:green;" data-toggle="collapse" data-target="#subd-${name}">Discovered Subdomains</div></li>
               <div id="subd-${name}"><b>${subd_array.length}</b> Subdomains Found!<br/><textarea style="background-color: black; width: 370px; height: 280px;color:green">${subd_string}</textarea></div>
               <li><div class="glyphicon glyphicon-triangle-right btn btn-info" style="color:green;" data-toggle="collapse" data-target="#dns">DNS Records</div></li>
               <li><div class="glyphicon glyphicon-triangle-right btn btn-info" style="color:green;" data-toggle="collapse" data-target="#whois">Whois</div></li>
               <li><div class="glyphicon glyphicon-triangle-right btn btn-info" style="color:green;" data-toggle="collapse" data-target="#vhd">Virtual Host Discovery</div></li>

             </div>
           </div>
         </div>
         <br/><br/>`).appendTo(new_div);
       }
       
     }

     $('textarea').each(function () {
           this.setAttribute('style', 'height:' + (this.scrollHeight) + 'px;overflow-y:hidden;');
           }).on('input', function () {
           this.style.height = 'auto';
           this.style.height = (this.scrollHeight) + 'px';
         });

       }
       

checklist_refresh("/socket/getJSONdata");
function checklist_flush_refresh(){
       $('#form-chk').empty();
}
       
     
function deleteTarget(a){
  checklist_flush_refresh();
       var deleteTargetName=a.getAttribute('id');
       var url_path= "/check/deleteTarget?deleteTargetName="+deleteTargetName;
       xhttp.open("GET",url_path,true);
       xhttp.send();
       console.log(a);
       console.log(deleteTargetName + " about to  be deleted!");
       xhttp.onreadystatechange = function(){
        if(this.status==200 && this.readyState == 4){
          console.log(xhttp.responseText);
          createOptioninList(xhttp.responseText);
        }
  }

  function createOptioninList(res){
 
    var new_div = document.createElement('div');
    $('#form-chk').append(new_div);

    var new_option;
    var json_res = JSON.parse(res);
   
    for(var num in json_res.domainArray){
     var domainName = json_res.domainArray[num]
      var name = domainName.replace(".","");
      var subd_array = json_res["subd"]["enumSubd"][domainName];
      
       var subd_string = subd_array.join('\n');
      $(`<input height="70px" width="70px" type="checkbox" name="${domainName}" class="form-check-input" id="materialChecked-${name}" onchange="handleChange(this);">
      <label class="form-check-label" for="materialChecked-${name}"><a href="http://${domainName}">${domainName}</a></label>
      <div class="glyphimcon glyphicon-arrow-right btn btn-info" style="color:green;float:right;" data-toggle="collapse" data-target="#info_res-${name}"></div>
      <a><div class="glyphicon glyphicon-refresh btn btn-info" style="color:green;float:right;"></div></a>
      <a id="${domainName}" onclick="deleteTarget(this);"><div class="glyphicon glyphicon-trash btn btn-danger" style="color:white;float:right;"></div></a>
      <div id="info_res-${name}" class="collapse">
        <ul class="nav nav-tabs md-tabs" id="myTabMD-${name}" role="tablist">
          <li class="nav-item">
            <a class="nav-link active btn btn-lg btn-danger" id="info-tab-md-${name}" data-toggle="tab" href="#info-md-${name}" role="tab" aria-controls="info-md-${name}"
              aria-selected="true">Info Tab</a>
          </li>
          <li class="nav-item">
            <a class="nav-link btn btn-lg btn-info" id="checklist-tab-md-${name}" data-toggle="tab" href="#checklist-md-${name}" role="tab" aria-controls="checklist-md-${name}"
              aria-selected="false">Checklist</a>
          </li>
        </ul>
        <div class="tab-content card pt-5" id="myTabContentMD-${name}">
          <div class="tab-pane fade" id="checklist-md-${name}" role="tabpanel" aria-labelledby="checklist-tab-md-${name}">

          </div>
          <div class="tab-pane fade" id="info-md-${name}" role="tabpanel" aria-labelledby="info-tab-md-${name}">
          <ul>
            <li><div class="glyphicon glyphicon-triangle-right btn btn-info" style="color:green;" data-toggle="collapse" data-target="#subd-${name}">Discovered Subdomains</div></li>
            <div id="subd-${name}"><b>${subd_array.length}</b> Subdomains Found!<br/><textarea style="background-color: black; width: 370px; height: 280px;color:green">${subd_string}</textarea></div>
            <li><div class="glyphicon glyphicon-triangle-right btn btn-info" style="color:green;" data-toggle="collapse" data-target="#dns">DNS Records</div></li>
            <li><div class="glyphicon glyphicon-triangle-right btn btn-info" style="color:green;" data-toggle="collapse" data-target="#whois">Whois</div></li>
            <li><div class="glyphicon glyphicon-triangle-right btn btn-info" style="color:green;" data-toggle="collapse" data-target="#vhd">Virtual Host Discovery</div></li>
          </ul>
          </div>
          <div class="tab-pane fade" id="info-md-${name}" role="tabpanel" aria-labelledby="info-tab-md-${name}">

          </div>
        </div>
      </div>
      <br/><br/>`).appendTo(new_div);
    }
    
  }

  $('textarea').each(function () {
        this.setAttribute('style', 'height:' + (this.scrollHeight) + 'px;overflow-y:hidden;');
        }).on('input', function () {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
      });

        
  }
function clearDB(){
  xhttp.open("GET",'/clearFilesAndDB',true);
  xhttp.send();

  xhttp.onreadystatechange = function(){
        if(this.status==200 && this.readyState == 4){
          checklist_flush_refresh();
        }
  }
}
function handleChange(checkbox) {
       if(checkbox.checked == true){
         $('input').each(function(){
           if($(this).attr('type')=='hidden'){
             $(this).attr('value',checkbox.name);
             Swal.fire({
               position: 'center',
               icon: 'success',
               title: '<i style="color:green;font-size:25px;">'+checkbox.name+"</i>&nbsp;<b style='color:white'>added to scope</b>",
               showConfirmButton: false,
               timer: 1500
             })
           }
         });
         
         $('#dInscope').html(checkbox.name);
         $('input').each(function(){
           if($(this).attr('type')=='checkbox' && $(this).attr('name')!=checkbox.name){
               $(this).prop("checked",false);
           }
         });
       }
       else{
         Swal.fire({
               position: 'center',
               icon: 'error',
               title: '<b style="color:green;font-size:30px;">'+checkbox.name+"</b>&nbsp;<b style='color:white'>removed from scope</b>",
               showConfirmButton: false,
               timer: 1500
             })
             $('input').each(function(){
           if($(this).attr('type')=='hidden'){
             $(this).attr('value','');
             Swal.fire({
               position: 'center',
               icon: 'error',
               title: '<b style="color:red;font-size:30px;">'+checkbox.name+"</b>&nbsp;<b style='color:white'>removed from scope</b>",
               showConfirmButton: false,
               timer: 1500
             })
           }
         });
         
         $('#dInscope').html("NONE");
       }
       }

function load(){
       $('<div style="color:yellow" class="lds-facebook"><div></div><div></div><div></div></div><div style="color:yellow">Loading...</div>').prependTo(document.getElementById('gear'));
       }

      //  <li><div class="glyphicon glyphicon-triangle-right btn btn-info" style="color:green;" data-toggle="collapse" data-target="#checklist-cors-${name}">CORS</div></li>
      //  <div id="checklist-cors-${name}"><b>${json_res.checklist["cors"][`${name}`].length}</b> CORS Found!<br/><textarea style="background-color: black; width: 370px; height: 280px;color:green">${json_res.checklist["cors"][`${name}`].join('\n')}</textarea></div>
       
      //  <li><div class="glyphicon glyphicon-triangle-right btn btn-info" style="color:green;" data-toggle="collapse" data-target="#checklist-hhi-${name}">HHI</div></li>
      //  <div id="checklist-hhi-${name}"><b>${json_res.checklist["hhi"][`${name}`].length}</b> HHI Found!<br/><textarea style="background-color: black; width: 370px; height: 280px;color:green">${json_res.checklist["hhi"][`${name}`].join('\n')}</textarea></div>
       
      //  <li><div class="glyphicon glyphicon-triangle-right btn btn-info" style="color:green;" data-toggle="collapse" data-target="#checklist-dmhttp-${name}">dmhttp</div></li>
      //  <div id="checklist-dmhttp-${name}"><b>${json_res.checklist["dmhttp"][`${name}`].length}</b> dmhttp Found!<br/><textarea style="background-color: black; width: 370px; height: 280px;color:green">${json_res.checklist["dmhttp"][`${name}`].join('\n')}</textarea></div>
       
      //  <li><div class="glyphicon glyphicon-triangle-right btn btn-info" style="color:green;" data-toggle="collapse" data-target="#checklist-subtake-${name}">subtake</div></li>
      //  <div id="checklist-subtake-${name}"><b>${json_res.checklist["subtake"][`${name}`].length}</b> subtake Found!<br/><textarea style="background-color: black; width: 370px; height: 280px;color:green">${json_res.checklist["subtake"][`${name}`].join('\n')}</textarea></div>
       
      //  <li><div class="glyphicon glyphicon-triangle-right btn btn-info" style="color:green;" data-toggle="collapse" data-target="#checklist-ctp-${name}">ctp</div></li>
      //  <div id="checklist-ctp-${name}"><b>${json_res.checklist["ctp"][`${name}`].length}</b> ctp Found!<br/><textarea style="background-color: black; width: 370px; height: 280px;color:green">${json_res.checklist["ctp"][`${name}`].join('\n')}</textarea></div>
       
      //  <li><div class="glyphicon glyphicon-triangle-right btn btn-info" style="color:green;" data-toggle="collapse" data-target="#checklist-cfc-${name}">cfc</div></li>
      //  <div id="checklist-cfc-${name}"><b>${json_res.checklist["cfc"][`${name}`].length}</b> cfc Found!<br/><textarea style="background-color: black; width: 370px; height: 280px;color:green">${json_res.checklist["cfc"][`${name}`].join('\n')}</textarea></div>
       
      //  <li><div class="glyphicon glyphicon-triangle-right btn btn-info" style="color:green;" data-toggle="collapse" data-target="#checklist-orc-${name}">ofc</div></li>
      //  <div id="checklist-ofc-${name}"><b>${json_res.checklist["ofc"][`${name}`].length}</b> ofc Found!<br/><textarea style="background-color: black; width: 370px; height: 280px;color:green">${json_res.checklist["ofc"][`${name}`].join('\n')}</textarea></div>
       
      //  <li><div class="glyphicon glyphicon-triangle-right btn btn-info" style="color:green;" data-toggle="collapse" data-target="#checklist-sslt-${name}">sslt</div></li>
      //  <div id="checklist-sslt-${name}"><b>${json_res.checklist["sslt"][`${name}`].length}</b> sslt Found!<br/><textarea style="background-color: black; width: 370px; height: 280px;color:green">${json_res.checklist["sslt"][`${name}`].join('\n')}</textarea></div>
       
      //  <li><div class="glyphicon glyphicon-triangle-right btn btn-info" style="color:green;" data-toggle="collapse" data-target="#checklist-pses-${name}">pses</div></li>
      //  <div id="checklist-pses-${name}"><b>${json_res.checklist["pses"][`${name}`].length}</b> pses Found!<br/><textarea style="background-color: black; width: 370px; height: 280px;color:green">${json_res.checklist["pses"][`${name}`].join('\n')}</textarea></div>
      // </ul>